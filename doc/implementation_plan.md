# План реализации проекта: Telegram-бот @fast_telegram_srm

Краткая цель: разработать отказоустойчивого Telegram-бота (Aiogram 3.x), который фиксирует новых подписчиков, пришедших по пригласительным ссылкам, и выгружает данные в Google Sheets; для быстрого маппинга канал ↔ лист используется локальная БД SQLite.

---

## Этап 0. Организация проекта и окружение

Элементарные задачи:
- Инициализировать репозиторий (если нужно) и базовую структуру директорий проекта.
- Выбрать менеджер зависимостей: pip + venv (по умолчанию) или poetry (по желанию).
- Создать файл зависимостей (`requirements.txt`) с базовым набором: aiogram>=3, gspread, gspread-asyncio, google-auth, aiosqlite, python-dotenv, pydantic-settings (опц.).
- Добавить базовый `.gitignore` (виртуальное окружение, .env, __pycache__, .pytest_cache и т.п.).
- Подготовить файл `.env.example` со схемой переменных окружения (без секретов).

Выходные артефакты:
- Структура каталогов и файл зависимостей.
- `.env.example`.

---

## Этап 1. Скелет приложения и конфигурация

Элементарные задачи:
- Создать каркас приложения со следующей рекомендуемой структурой:
	- `app/main.py` — точка входа (инициализация диспетчера, роутеров, запуск polling/webhook).
	- `app/config.py` — загрузка конфигурации из переменных окружения (pydantic-settings или вручную).
	- `app/handlers/` — пакет обработчиков (`my_chat_member.py`, `chat_member.py`).
	- `app/filters/` — пользовательские фильтры/условия (если потребуются).
	- `app/services/google_sheets.py` — клиент и обертки для gspread-asyncio.
	- `app/services/db.py` — инициализация и доступ к SQLite (aiosqlite).
	- `app/models/` — общие типы/DTO (если потребуется).
	- `app/utils/` — утилиты (логирование, форматирование, санитизация названий листов и т.д.).
	- `app/logging.py` — базовая настройка логгера.
- Реализовать `config.py`:
	- BOT_TOKEN — токен бота.
	- GOOGLE_SERVICE_ACCOUNT_JSON — путь к JSON-ключу сервисного аккаунта.
	- GOOGLE_SPREADSHEET_ID — ID мастер-таблицы.
	- DB_PATH — путь к локальной базе SQLite (например, `./data/app.db`).
	- OPTIONAL: LOG_LEVEL, SENTRY_DSN и др.
- Подключить базовое логирование (консоль + при желании файловый хэндлер).

Выходные артефакты:
- Каркас исходников и конфигурация.

---

## Этап 2. Интеграция с Google Sheets

Элементарные задачи:
- Создать/подготовить сервисный аккаунт в Google Cloud; получить JSON-ключ.
- Выдать доступ «Редактор» сервисному аккаунту к целевой Google-таблице (по email аккаунта).
- Установить и настроить `gspread` и `gspread-asyncio`:
	- Создать `AsyncioGspreadClientManager` (функция-фабрика с credential объектом).
	- Реализовать хелперы: получение клиента, получение Spreadsheet по ID.
- Реализовать утилиту «гарантированного наличия листа» для канала:
	- Функция `ensure_sheet(title: str) -> Worksheet`.
	- Санитизация названия (ограничения Google Sheets) и разрешение коллизий.
	- Если лист новый: добавить заголовочную строку из ТЗ: Timestamp, User ID, Full Name, Username, Invite Link, Link Name.
- Реализовать асинхронную запись строки:
	- Функция `append_row(sheet_title: str, row: list[str|int|None])` с ретраями и экспоненциальной задержкой (обработка сетевых ошибок и 429).

Выходные артефакты:
- `app/services/google_sheets.py` с клиентом, ensure_sheet, append_row.

---

## Этап 3. Локальная БД SQLite (кеш соответствий)

Элементарные задачи:
- Создать каталог `data/` (для хранения SQLite).
- Спроектировать схему БД:
	- Таблица `channels`:
		- `channel_id INTEGER PRIMARY KEY`.
		- `sheet_name TEXT NOT NULL`.
		- `created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP`.
- Реализовать инициализацию базы на старте (`init_db`): создать таблицу при отсутствии.
- Реализовать DAO-слой:
	- `get_sheet_name(channel_id) -> str | None`.
	- `upsert_channel(channel_id, sheet_name)`.
	- (Опционально) таблица `events` для дедупликации записей по уникальному ключу события.

Выходные артефакты:
- `app/services/db.py` (инициализация и CRUD).

---

## Этап 4. Обработчик инициализации канала (my_chat_member)

Элементарные задачи:
- Создать роутер `router_my_chat_member` и зарегистрировать хэндлер для события `my_chat_member`.
- Отфильтровать события, где бот получает права администратора в канале.
- Извлечь `channel_id` и «читаемое» название канала.
- Проверить наличие маппинга в SQLite:
	- Если нет — вызвать `ensure_sheet(<channel_title>)` и получить итоговое `sheet_name`.
	- Сохранить `channel_id ↔ sheet_name` в таблице `channels`.
- Логировать ключевые шаги и ошибки (без утечки приватных данных).

Выходные артефакты:
- `app/handlers/my_chat_member.py` с рабочей логикой и регистрацией в `main.py`.

---

## Этап 5. Обработчик новых подписчиков (chat_member)

Элементарные задачи:
- Создать роутер `router_chat_member` и хэндлер для `chat_member`.
- Применить условия с помощью фильтров/гвардов:
	- Новый статус участника — `member`.
	- Событие содержит `invite_link` (пользователь пришёл по приглашению).
- Извлечь данные из апдейта:
	- `user.id`, `user.full_name`, `user.username` (может отсутствовать),
	- `invite_link.invite_link`, `invite_link.name` (может отсутствовать),
	- текущий `datetime.now()` в целевой таймзоне (уточнить TZ, по умолчанию UTC или локальная).
- По `channel_id` получить `sheet_name` из SQLite; если отсутствует — вызвать fallback: `ensure_sheet()` + сохранить маппинг.
- Сформировать строку для записи согласно ТЗ и вызвать `append_row`.
- Обработать ошибки:
	- Сетевые/квотные (ретраи), логирование.
	- (Опционально) дедупликация события/повторная запись (таблица `events`).

Выходные артефакты:
- `app/handlers/chat_member.py` с фильтрами и основной логикой записи в таблицу.

---

## Этап 6. Надёжность, логирование и мониторинг

Элементарные задачи:
- Настроить единый формат логов (уровни INFO/ERROR, включить контекст: channel_id, user_id, operation).
- Добавить обработку исключений вокруг сетевых вызовов (Google API) с ретраями и backoff.
- (Опционально) Интегрировать Sentry для ошибок в проде.
- (Опционально) Метрики (Prometheus) — при необходимости.

Выходные артефакты:
- Конфиг логирования, единые вызовы логгера, ретраи в сервисах.

---

## Этап 7. Тестирование

Элементарные задачи:
- Юнит-тесты:
	- Тесты `ensure_sheet` (мокаем gspread, проверяем создание заголовков единожды).
	- Тесты DAO для SQLite (временная БД в памяти).
- Интеграционные тесты (по возможности):
	- Тестовая Google-таблица, запись строки `append_row` и валидация результата.
- Тесты обработчиков (мокаем апдейты `chat_member`/`my_chat_member`).

Выходные артефакты:
- Набор тестов и инструкции по запуску.

---

## Этап 8. Развёртывание (Ubuntu 22.04 LTS, systemd)

Элементарные задачи:
- Подготовить сервер: Python 3.11+, создание системного пользователя приложения, директории для кода и данных.
- Залить код и установить зависимости в виртуальном окружении.
- Передать `.env` и JSON-ключ сервисного аккаунта (права на чтение только приложению).
- Создать `systemd` unit:
	- Описать ExecStart с запуском `python -m app.main`.
	- Указать переменные окружения или путь к `.env` (через EnvironmentFile).
	- Настроить `Restart=always`, `RestartSec=5`, `WorkingDirectory`, `User`, `Group`.
- Проверить журнал (`journalctl -u <service>.service -f`) и автоперезапуск.

Выходные артефакты:
- Юнит-файл systemd и инструкция по установке/перезапуску.

---

## Этап 9. Документация и передача

Элементарные задачи:
- Обновить `README.md`:
	- Установка и запуск локально.
	- Настройка Google Service Account и доступ к Spreadsheet.
	- Переменные окружения и их значение.
	- Схема данных и ограничения.
	- Развёртывание на сервере (systemd).
- Подготовить контрольный список приёмки и smoke-тесты.
- Передать ссылку на мастер-файл Google Sheets и убедиться, что сервисный аккаунт имеет доступ.

Выходные артефакты:
- Актуальная документация и чек-листы.

---

## Риски и меры

- Квоты/лимиты Google Sheets (429, 5xx): ретраи с backoff, пакетирование при необходимости.
- Неполные данные пользователя (нет username, пустое имя): безопасные значения по умолчанию.
- Нет прав у бота в канале: проверка и информирование (лог + при необходимости сервисное уведомление администратору).
- Коллизии имён листов: стратегия уникализации (например, добавлять суффикс `_<id>`).
- Потеря соединения: авто-перезапуск через systemd, ретраи на уровне сервисов.

---

## Быстрые критерии готовности (DoD)

- Бот добавлен в канал как администратор — создаётся лист и заголовки.
- На нового подписчика по пригласительной ссылке — строка добавляется в соответствующий лист с корректными полями.
- Маппинг `channel_id ↔ sheet_name` хранится локально, используется без лишних запросов.
- Приложение переживает сетевые сбои (ретраи) и перезапуски (systemd).
- Документация описывает установку, настройку и развёртывание.

---

## Следующие шаги (оперативный чек-лист)

1) Создать `requirements.txt` и установить окружение.
2) Подготовить `.env.example` и загрузчик конфигурации.
3) Реализовать сервис Google Sheets (ensure_sheet, append_row).
4) Реализовать SQLite DAO (init_db, get_sheet_name, upsert_channel).
5) Написать обработчики `my_chat_member` и `chat_member` и связать их в `main.py`.
6) Добавить логирование и базовые тесты.
7) Подготовить unit-файл systemd и инструкции в README.

